import"./modulepreload-polyfill-B5Qt9EMX.js";import{S as K}from"./config-DgteQrrW.js";let p="",s=1;function G(c){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c,{once:!0}):c()}async function Y(){try{const c=await fetch("/api/csrf-token");if(!c.ok)throw new Error("Failed to get token CSRF.");p=(await c.json()).csrfToken,console.log("CSRF Token obtenido:",p),ee()}catch(c){console.error("Error getting token CSRF:",c),document.body.classList.add("loading"),alert("The application could not be loaded. Please try again later.")}}function ee(){G(()=>{const c=document.getElementById("bookingForm"),y=document.querySelectorAll(".booking-step"),O=document.querySelectorAll("[data-step]");document.getElementById("wizard-nav-buttons");const w=document.querySelector('select[name="cPay"]'),g=document.getElementById("stripe-payment-form"),a=document.getElementById("submit-payment"),d=document.getElementById("termsCheck"),x=document.getElementById("payment-message"),A=document.querySelector('input[name="bDate"]'),P=document.getElementById("quickQuoteForm"),B=document.getElementById("estPrice");document.querySelectorAll("form button[data-prev], form button[data-next]").forEach(e=>{e.hasAttribute("type")||e.setAttribute("type","button")});const E=document.querySelectorAll("[data-view]"),Q=document.querySelectorAll("[data-link]"),v=e=>{e&&(E.forEach(t=>{t.classList.toggle("active",t.id===e)}),Q.forEach(t=>{const o=(t.getAttribute("href")||"").replace(/^#/,"")===e;t.classList.toggle("active",o)}),location.hash!==`#${e}`&&history.pushState({view:e},"",`#${e}`))},F=(location.hash||"").replace(/^#/,"")||E[0]&&E[0].id||null;F&&v(F),window.addEventListener("popstate",()=>{const e=(location.hash||"").replace(/^#/,"");e&&v(e)}),document.body.addEventListener("click",e=>{const t=e.target.closest("[data-link]");if(!t)return;const n=t.getAttribute("href")||"";if(!n.startsWith("#"))return;e.preventDefault();const o=n.substring(1);v(o)});function j(){O.forEach(e=>{const t=Number(e.getAttribute("data-booking-step")||"0");e.classList.toggle("active",t===s),e.classList.toggle("completed",t<s)})}function l(e){if(e<1||e>y.length)return!1;y.forEach((n,o)=>{n.classList.toggle("d-none",o+1!==e)}),s=e,j();const t=document.querySelector("#wizard-nav-buttons [data-next]");return t&&(e===y.length?t.textContent="Confirm and Pay":t.textContent="Following"),!0}document.querySelectorAll("[data-next]").forEach(e=>{e.addEventListener("click",async t=>{t.preventDefault(),C(s)&&(s<y.length?l(s+1):w?.value==="card"?a?.click():await M())})}),document.querySelectorAll("[data-prev]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),s>1&&l(s-1)})});function C(e){const t=document.querySelector(`[data-booking-step="${e}"]`);if(!t)return!0;const n=t.querySelectorAll("input, select, textarea");for(const o of n)if(!o.checkValidity())return o.reportValidity(),!1;return!0}const L=document.querySelectorAll("[data-service]");L.length&&L.forEach(e=>{e.addEventListener("click",()=>{L.forEach(o=>o.classList.remove("selected")),e.classList.add("selected");const t=e.getAttribute("data-service"),n=document.querySelector('input[name="bService"]');n&&(n.value=t),l(2),u()})}),l(s),u();const N=Stripe(K);let b=null,T=null,S=null,k=null,q=null;const m=e=>{x&&(x.textContent=e||"")},h=()=>m("");function R(e,t="USD",n=navigator.language){if(e==null||isNaN(e))return"—";const o=e/100;try{return new Intl.NumberFormat(n,{style:"currency",currency:t}).format(o)}catch{return`${o} ${t}`}}function z(){let e,t,n,o,r;const i=document.getElementById("booking");if(i&&i.classList.contains("active")){const f=document.querySelector("[data-service].selected");e=f?f.getAttribute("data-service"):null,t=Number(document.querySelector('[data-booking-step="2"] input[name="bBeds"]')?.value||"0"),n=Number(document.querySelector('[data-booking-step="2"] input[name="bBaths"]')?.value||"1"),o=document.querySelector('[data-booking-step="2"] select[name="bFreq"]')?.value||"Once",r=document.querySelector('[data-booking-step="3"] input[name="bZip"]')?.value||"0000"}else e=document.querySelector('#quickQuoteForm select[name="service"]')?.value||null,t=Number(document.querySelector('#quickQuoteForm input[name="bBeds"]')?.value||"0"),n=Number(document.querySelector('#quickQuoteForm input[name="bBaths"]')?.value||"1"),o=document.querySelector('#quickQuoteForm select[name="bFreq"]')?.value||"Once",r=document.querySelector('#quickQuoteForm input[name="zip"]')?.value||"";const I=Array.from(document.querySelectorAll('[data-booking-step="2"] input[type="checkbox"]:checked')).map(f=>f.value);return e?{serviceCode:e,beds:t,baths:n,freq:o,extras:I,zip:r}:(console.log("Incomplete quote data: missing serviceCode."),null)}function U(){const e=document.querySelector("[data-service].selected");return e&&e.getAttribute("data-service")||null}function V(){return Array.from(document.querySelectorAll('[data-booking-step="2"] input[type="checkbox"]:checked')).map(e=>e.value)}function W(e,t){B&&(B.textContent=R(e,t||"USD"))}function $(){const e=U(),t=Number(document.querySelector('input[name="bBeds"]')?.value||""),n=Number(document.querySelector('input[name="bBaths"]')?.value||"1"),o=(document.querySelector('select[name="bFreq"]')?.value||"Once").trim(),r=V(),i=(document.querySelector('input[name="bDate"]')?.value||"").trim(),I=(document.querySelector('input[name="bTime"]')?.value||"").trim(),f=(document.querySelector('input[name="bAddress"]')?.value||"").trim(),X=(document.querySelector('input[name="bZip"]')?.value||"").trim(),Z=(document.querySelector('input[name="cName"]')?.value||"").trim(),_=(document.querySelector('input[name="cEmail"]')?.value||"").trim(),H=(document.querySelector('input[name="cPhone"]')?.value||"").trim();return{serviceCode:e,beds:t,baths:n,freq:o,extras:r,date:i,time:I,address:f,zip:X,customer:{name:Z,email:_,phone:H}}}let D;function u(){return clearTimeout(D),new Promise((e,t)=>{D=setTimeout(async()=>{const n=z();if(!n)return console.log("Incomplete quote data, the API call will not be made."),e(null);k&&k.abort(),k=new AbortController;try{h();const o=await fetch("/api/pricing/quote",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":p},body:JSON.stringify(n),signal:k.signal});if(!o.ok)throw new Error(await o.text()||"Pricing service not available.");const r=await o.json();S=r,W(r.amount,r.currency);const i=document.getElementById("quickQuoteResult");i&&(i.classList.remove("d-none","alert"),i.classList.add("alert-info"),n.serviceCode==="Regular"?n.serviceCode="House Cleaning":n.serviceCode=`${n.serviceCode} Cleaning`,i.innerHTML=`
                <div><strong>Estimated price::</strong> ${R(r.amount,r.currency)}</div>
                <div class="small text-muted">
                  Service: ${n.serviceCode} · Rooms: ${n.beds} · Bathrooms: ${n.baths} · Frequency: ${n.freq}
                  ${n.extras?.length?" · Extras: "+n.extras.join(", "):""}
                  ${n.zip?" · Zip code: "+n.zip:""}
                </div>
              `),e(r)}catch(o){console.error(o),S=null;const r=document.getElementById("quickQuoteResult");r&&(r.classList.remove("d-none","alert-info"),r.classList.add("alert"),r.textContent="The quote could not be calculated. Please check your input."),m("The quote could not be refreshed. Please try again."),t(o)}},250)})}['[data-booking-step="2"] input','[data-booking-step="2"] select','[data-booking-step="2"] input[type="checkbox"]',"[data-service]"].forEach(e=>{document.querySelectorAll(e).forEach(t=>{t.addEventListener("input",u),t.addEventListener("change",u)})}),P&&P.addEventListener("submit",e=>{e.preventDefault(),u()});async function J(){if(!(b&&T))try{a&&(a.disabled=!0),h(),await u();const e=$(),t=await fetch("/api/bookings",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":p},body:JSON.stringify({...e,quoteId:S?.quoteId||null})});if(!t.ok)throw new Error(await t.text()||"The reservation could not be created.");if(q=(await t.json())?.id,!q)throw new Error("Reservation ID is missing.");const o=await fetch("/api/payments/stripe/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":p},body:JSON.stringify({bookingId:q})});if(!o.ok)throw new Error(await o.text()||"The PaymentIntent could not be created.");const{clientSecret:r}=await o.json();if(!r)throw new Error("The clientSecret is missing.");b=N.elements({clientSecret:r}),T=b.create("payment",{fields:{billingDetails:{address:"never"}}}),T.mount("#payment-element"),a&&(a.disabled=!(d?.checked&&!g?.classList.contains("hidden")))}catch(e){console.error(e),m(e.message||"Error initializing payment."),a&&(a.disabled=!0)}}w&&w.addEventListener("change",async e=>{if(e.target.value==="card"){const t=C(2),n=C(3);if(!t||!n){m("Complete the previous steps before proceeding to payment."),l(t?3:2),g?.classList.add("d-none"),a&&(a.disabled=!0);return}g?.classList.remove("d-none"),await J(),a&&(a.disabled=!d?.checked)}else g?.classList.add("d-none"),h(),a&&(a.disabled=!0)}),d&&a&&d.addEventListener("change",()=>{g?.classList.contains("d-none")||(a.disabled=!d.checked)});async function M(){const e=document.querySelector("#wizard-nav-buttons [data-next]");e&&(e.disabled=!0),h();try{await u();const t=$(),n=await fetch("/api/bookings",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":p},body:JSON.stringify({...t,quoteId:S?.quoteId||null})});if(!n.ok){const o=await n.text();throw new Error(o||"The reservation could not be created.")}alert("Reservation confirmed! We'll contact you to coordinate payment."),c.reset(),l(1),v("home")}catch(t){m(t.message||"An error occurred while creating the reservation.")}finally{e&&(e.disabled=!1)}}if(a&&a.addEventListener("click",async()=>{if(!b||!d?.checked)return;a.disabled=!0,h();const{error:e}=await N.confirmPayment({elements:b,confirmParams:{return_url:`${window.location.origin}/stripe/return?booking_id=${encodeURIComponent(q)}`}});e&&(m(e.message||"Payment error"),a.disabled=!1)}),A){const e=new Date().toISOString().split("T")[0];A.setAttribute("min",e)}})}Y();
