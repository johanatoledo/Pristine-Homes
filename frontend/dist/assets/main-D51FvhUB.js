import"./modulepreload-polyfill-B5Qt9EMX.js";import{S as G}from"./config-DgteQrrW.js";let y="",i=1;function Y(a){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",a,{once:!0}):a()}async function ee(){try{const a=await fetch("/api/csrf-token");if(!a.ok)throw new Error("No se pudo obtener el token CSRF.");y=(await a.json()).csrfToken,console.log("CSRF Token obtenido:",y),te()}catch(a){console.error("Error al obtener el token CSRF:",a),document.body.classList.add("loading"),alert("No se pudo cargar la aplicación. Intenta de nuevo más tarde.")}}function te(){Y(()=>{document.getElementById("bookingForm");const a=document.querySelectorAll(".booking-step"),I=document.querySelectorAll("[data-step]"),A=document.getElementById("wizard-nav-buttons"),N=document.querySelector('select[name="cPay"]'),m=document.getElementById("stripe-payment-form"),r=document.getElementById("submit-payment"),s=document.getElementById("termsCheck"),F=document.getElementById("payment-message"),T=document.querySelector('input[name="bDate"]'),g=document.getElementById("quickQuoteForm"),x=document.getElementById("estPrice");document.querySelectorAll("form button[data-prev], form button[data-next]").forEach(e=>{e.hasAttribute("type")||e.setAttribute("type","button")});const S=document.querySelectorAll("[data-view]"),$=document.querySelectorAll("[data-link]"),k=e=>{e&&(S.forEach(t=>{t.classList.toggle("active",t.id===e)}),$.forEach(t=>{const o=(t.getAttribute("href")||"").replace(/^#/,"")===e;t.classList.toggle("active",o)}),location.hash!==`#${e}`&&history.pushState({view:e},"",`#${e}`))},B=(location.hash||"").replace(/^#/,"")||S[0]&&S[0].id||null;B&&k(B),window.addEventListener("popstate",()=>{const e=(location.hash||"").replace(/^#/,"");e&&k(e)}),document.body.addEventListener("click",e=>{const t=e.target.closest("[data-link]");if(!t)return;const n=t.getAttribute("href")||"";if(!n.startsWith("#"))return;e.preventDefault();const o=n.substring(1);k(o)});function z(){I.forEach(e=>{const t=Number(e.getAttribute("data-booking-step")||"0");e.classList.toggle("active",t===i),e.classList.toggle("completed",t<i)})}function l(e){return e<1||e>a.length?!1:(a.forEach((t,n)=>{t.classList.toggle("d-none",n+1!==e)}),i=e,z(),A&&A.classList.toggle("d-none",e===a.length),!0)}document.querySelectorAll("[data-next]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),q(i)&&i<a.length&&l(i+1)})}),document.querySelectorAll("[data-prev]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),i>1&&l(i-1)})});function q(e){const t=document.querySelector(`[data-booking-step="${e}"]`);if(!t)return!0;const n=t.querySelectorAll("input, select, textarea");for(const o of n)if(!o.checkValidity())return o.reportValidity(),!1;return!0}const E=document.querySelectorAll("[data-service]");E.length&&E.forEach(e=>{e.addEventListener("click",()=>{E.forEach(o=>o.classList.remove("selected")),e.classList.add("selected");const t=e.getAttribute("data-service"),n=document.querySelector('input[name="bService"]');n&&(n.value=t),l(2),u()})}),l(i),u();const P=Stripe(G);let f=null,w=null,C=null,v=null,b=null;const p=e=>{F&&(F.textContent=e||"")},h=()=>p("");function R(e,t="USD",n=navigator.language){if(e==null||isNaN(e))return"—";const o=e/100;try{return new Intl.NumberFormat(n,{style:"currency",currency:t}).format(o)}catch{return`${o} ${t}`}}function Q(){let e,t,n,o,c;if(g&&!g.classList.contains("hidden"))e=document.querySelector('#quickQuoteForm select[name="service"]')?.value||null,t=Number(document.querySelector('#quickQuoteForm input[name="bBeds"]')?.value||"0"),n=Number(document.querySelector('#quickQuoteForm input[name="bBaths"]')?.value||"1"),o=document.querySelector('#quickQuoteForm select[name="bFreq"]')?.value||"Once",c=document.querySelector('#quickQuoteForm input[name="zip"]')?.value||"";else{const d=document.querySelector("[data-service].selected");e=d?d.getAttribute("data-service"):null,t=Number(document.querySelector('[data-booking-step="2"] input[name="bBeds"]')?.value||"0"),n=Number(document.querySelector('[data-booking-step="2"] input[name="bBaths"]')?.value||"1"),o=document.querySelector('[data-booking-step="2"] select[name="bFreq"]')?.value||"Once",c=document.querySelector('[data-booking-step="3"] input[name="bZip"]')?.value||"0000"}const L=Array.from(document.querySelectorAll('[data-booking-step="2"] input[type="checkbox"]:checked')).map(d=>d.value);return e?{serviceCode:e,beds:t,baths:n,freq:o,extras:L,zip:c}:(console.log("Datos de cotización incompletos: falta serviceCode."),null)}function O(){const e=document.querySelector("[data-service].selected");return e&&e.getAttribute("data-service")||null}function j(){return Array.from(document.querySelectorAll('[data-booking-step="2"] input[type="checkbox"]:checked')).map(e=>e.value)}function U(e){if(e==null)return null;let t=typeof e=="string"?Number(e):e;return Number.isFinite(t)?Number.isInteger(t)?t<1e3?t*100:t:Math.round(t*100):null}function V(e,t="USD",n=navigator.language){const o=U(e);if(o==null)return"—";const c=o/100;try{return new Intl.NumberFormat(n,{style:"currency",currency:t}).format(c)}catch{return`${c} ${t}`}}function M(e,t){x&&(x.textContent=V(e,t||"USD"))}function W(){const e=O(),t=Number(document.querySelector('input[name="bBeds"]')?.value||""),n=Number(document.querySelector('input[name="bBaths"]')?.value||"1"),o=(document.querySelector('select[name="bFreq"]')?.value||"Once").trim(),c=j(),L=(document.querySelector('input[name="bDate"]')?.value||"").trim(),d=(document.querySelector('input[name="bTime"]')?.value||"").trim(),X=(document.querySelector('input[name="bAddress"]')?.value||"").trim(),Z=(document.querySelector('input[name="bZip"]')?.value||"").trim(),_=(document.querySelector('input[name="cName"]')?.value||"").trim(),H=(document.querySelector('input[name="cEmail"]')?.value||"").trim(),K=(document.querySelector('input[name="cPhone"]')?.value||"").trim();return{serviceCode:e,beds:t,baths:n,freq:o,extras:c,date:L,time:d,address:X,zip:Z,customer:{name:_,email:H,phone:K}}}let D;async function u(){clearTimeout(D),D=setTimeout(async()=>{const e=Q();if(!e){console.log("Datos de cotización incompletos, no se hará la llamada a la API.");return}v&&v.abort(),v=new AbortController;try{h();const t=await fetch("/api/pricing/quote",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":y},body:JSON.stringify(e),signal:v.signal});if(!t.ok)throw new Error(await t.text()||"Pricing service not available.");const n=await t.json();C=n,M(n.amount,n.currency);const o=document.getElementById("quickQuoteResult");o&&(o.classList.remove("d-none","alert"),o.classList.add("alert-info"),e.serviceCode==="Regular"?e.serviceCode="House Cleaning":e.serviceCode=`${e.serviceCode} Cleaning`,o.innerHTML=`
              <div><strong>Estimated price::</strong> ${R(n.amount,n.currency)}</div>
              <div class="small text-muted">
                Service: ${e.serviceCode} · Rooms: ${e.beds} · Bathrooms: ${e.baths} · Frequency: ${e.freq}
                ${e.extras?.length?" · Extras: "+e.extras.join(", "):""}
                ${e.zip?" · Zip code: "+e.zip:""}
              </div>
            `)}catch(t){console.error(t),C=null;const n=document.getElementById("quickQuoteResult");n&&(n.classList.remove("d-none","alert-info"),n.classList.add("alert"),n.textContent="No se pudo calcular la cotización. Por favor, revisa tus datos de entrada."),p("No se pudo refrescar la cotización. Intenta de nuevo.")}},250)}['[data-booking-step="2"] input','[data-booking-step="2"] select','[data-booking-step="2"] input[type="checkbox"]',"[data-service]"].forEach(e=>{document.querySelectorAll(e).forEach(t=>{t.addEventListener("input",u),t.addEventListener("change",u)})}),g&&g.addEventListener("submit",e=>{e.preventDefault(),u()});async function J(){if(!(f&&w))try{r&&(r.disabled=!0),h(),await u();const e=W(),t=await fetch("/api/bookings",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":y},body:JSON.stringify({...e,quoteId:C?.quoteId||null})});if(!t.ok)throw new Error(await t.text()||"No se pudo crear la reserva.");if(b=(await t.json())?.id,!b)throw new Error("Falta el ID de la reserva.");const o=await fetch("/stripe/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":y},body:JSON.stringify({bookingId:b})});if(!o.ok)throw new Error(await o.text()||"No se pudo crear el PaymentIntent.");const{clientSecret:c}=await o.json();if(!c)throw new Error("Falta el clientSecret.");f=P.elements({clientSecret:c}),w=f.create("payment",{fields:{billingDetails:{address:"never"}}}),w.mount("#payment-element"),r&&(r.disabled=!(s?.checked&&!m?.classList.contains("hidden")))}catch(e){console.error(e),p(e.message||"Error inicializando el pago."),r&&(r.disabled=!0)}}if(N&&N.addEventListener("change",async e=>{if(e.target.value==="card"){const t=q(2),n=q(3);if(!t||!n){p("Completa los pasos previos antes de proceder al pago."),l(t?3:2),m?.classList.add("hidden"),r&&(r.disabled=!0);return}m?.classList.remove("hidden"),await J(),r&&(r.disabled=!s?.checked)}else m?.classList.add("hidden"),h(),r&&(r.disabled=!0)}),s&&r&&s.addEventListener("change",()=>{m?.classList.contains("hidden")||(r.disabled=!s.checked)}),r&&r.addEventListener("click",async()=>{if(!f||!s?.checked)return;r.disabled=!0,h();const{error:e}=await P.confirmPayment({elements:f,confirmParams:{return_url:`${window.location.origin}/stripe/return?booking_id=${encodeURIComponent(b)}`}});e&&(p(e.message||"Error en el pago"),r.disabled=!1)}),T){const e=new Date().toISOString().split("T")[0];T.setAttribute("min",e)}})}ee();
